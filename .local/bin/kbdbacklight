#!/bin/bash -e
path="/sys/class/leds/spi::kbd_backlight"

if [ $# -ne 0 ] && [ $# -ne 1 ]; then
	echo "Usage: $0 [=|-|+][brightness]" >&2
	exit 1
fi

max="$(cat "$path"/max_brightness)"
cur="$(cat "$path"/brightness)"

if [ $# -eq 0 ]; then
	uncalc() {
		echo $(expr $(expr $1 '*' 100) / $max)
	}

	echo $(uncalc $cur)
else
	first="${1::1}"
	last="${1:1}"

	calc() {
		echo $(expr $(expr $1 '*' $max) / 100)
	}

	if [ "$first" == "+" ]; then
		cur="$(expr $cur + "$(calc $last)")"
	elif [ "$first" == "-" ]; then
		cur="$(expr $cur - "$(calc $last)")"
	elif [ "$first" == "=" ]; then
		cur="$(calc $last)"
	else
		cur="$(calc $1)"
	fi

	if [ $cur -gt $max ]; then
		cur=$max
	elif [ $cur -lt 0 ]; then
		cur=0
	fi

	if [ $(stat -c %a "$path"/brightness) -ne 664 ]; then
		pkexec /bin/chown root:input "$path"/brightness
		pkexec /bin/chmod 664 "$path"/brightness
	fi

	echo $cur >"$path"/brightness
fi
